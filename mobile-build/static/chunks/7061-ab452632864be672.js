"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[7061],{6253:(e,r,t)=>{t.d(r,{AuthErrorBoundary:()=>p,useAuthErrorHandler:()=>y});var s=t(95155),n=t(12115),o=t(3998),i=t(86948),l=t(89559),a=t(59865),c=t(15870),u=t(96583),d=t(52056),h=t(20908),g=t(11647),f=t(76202);function m(e){let{error:r,onRetry:t,onAction:n,variant:m="card",showDetails:p=!1,className:y=""}=e,w=()=>{switch(r.type){case f.L4.NETWORK_ERROR:case f.L4.TIMEOUT_ERROR:return(0,s.jsx)(l.A,{className:"h-5 w-5 text-orange-500"});case f.L4.INVALID_CREDENTIALS:case f.L4.SESSION_EXPIRED:return(0,s.jsx)(a.A,{className:"h-5 w-5 text-red-500"});case f.L4.PROFILE_NOT_FOUND:case f.L4.PROFILE_INCOMPLETE:return(0,s.jsx)(c.A,{className:"h-5 w-5 text-blue-500"});case f.L4.USER_NOT_FOUND:return(0,s.jsx)(u.A,{className:"h-5 w-5 text-green-500"});default:return(0,s.jsx)(d.A,{className:"h-5 w-5 text-red-500"})}},v=()=>{switch(r.type){case f.L4.NETWORK_ERROR:case f.L4.TIMEOUT_ERROR:case f.L4.PROFILE_INCOMPLETE:return"warning";case f.L4.USER_NOT_FOUND:case f.L4.EMAIL_NOT_CONFIRMED:return"info";default:return"error"}},x=()=>{if(!r.action)return null;let e={retry:{label:"Try Again",icon:l.A,variant:"default"},login:{label:"Sign In",icon:a.A,variant:"default"},signup:{label:"Sign Up",icon:u.A,variant:"default"},complete_profile:{label:"Complete Profile",icon:c.A,variant:"default"},contact_support:{label:"Contact Support",icon:h.A,variant:"outline"}}[r.action];if(!e)return null;let i=e.icon;return(0,s.jsxs)(o.$,{onClick:()=>(e=>{if(n)n(e);else switch(e){case"login":window.location.href="/auth/login";break;case"signup":window.location.href="/auth/signup";break;case"complete_profile":window.location.href="/auth/complete-profile";break;case"retry":default:t&&t();break;case"contact_support":window.location.href="/contact"}})(r.action),variant:e.variant,size:"sm",className:"flex items-center space-x-2",children:[(0,s.jsx)(i,{className:"h-4 w-4"}),(0,s.jsx)("span",{children:e.label})]})};return"inline"===m?(0,s.jsxs)("div",{className:"flex items-center space-x-3 p-3 rounded-lg border ".concat("error"===v()?"border-red-200 bg-red-50":"warning"===v()?"border-orange-200 bg-orange-50":"border-blue-200 bg-blue-50"," ").concat(y),children:[w(),(0,s.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,s.jsx)("p",{className:"text-sm font-medium text-gray-900",children:r.userMessage}),p&&(0,s.jsx)("p",{className:"text-xs text-gray-500 mt-1",children:r.message})]}),x()]}):"banner"===m?(0,s.jsx)("div",{className:"border-l-4 p-4 ".concat("error"===v()?"border-red-400 bg-red-50":"warning"===v()?"border-orange-400 bg-orange-50":"border-blue-400 bg-blue-50"," ").concat(y),children:(0,s.jsxs)("div",{className:"flex items-start",children:[(0,s.jsx)("div",{className:"flex-shrink-0",children:w()}),(0,s.jsxs)("div",{className:"ml-3 flex-1",children:[(0,s.jsx)("p",{className:"text-sm font-medium text-gray-900",children:r.userMessage}),p&&(0,s.jsx)("p",{className:"text-xs text-gray-500 mt-1",children:r.message}),(0,s.jsxs)("div",{className:"mt-3 flex space-x-2",children:[x(),r.retryable&&t&&(0,s.jsx)(o.$,{onClick:t,variant:"outline",size:"sm",children:"Try Again"})]})]})]})}):"toast"===m?(0,s.jsx)("div",{className:"max-w-sm w-full bg-white shadow-lg rounded-lg pointer-events-auto ring-1 ring-black ring-opacity-5 ".concat(y),children:(0,s.jsx)("div",{className:"p-4",children:(0,s.jsxs)("div",{className:"flex items-start",children:[(0,s.jsx)("div",{className:"flex-shrink-0",children:w()}),(0,s.jsxs)("div",{className:"ml-3 w-0 flex-1",children:[(0,s.jsx)("p",{className:"text-sm font-medium text-gray-900",children:"Authentication Error"}),(0,s.jsx)("p",{className:"mt-1 text-sm text-gray-500",children:r.userMessage}),(0,s.jsx)("div",{className:"mt-3 flex space-x-2",children:x()})]})]})})}):(0,s.jsxs)(i.Zp,{className:"".concat(y),children:[(0,s.jsxs)(i.aR,{className:"pb-3",children:[(0,s.jsxs)("div",{className:"flex items-center space-x-2",children:[w(),(0,s.jsx)(i.ZB,{className:"text-lg",children:"Authentication Error"}),(0,s.jsx)(g.E,{variant:"error"===v()?"destructive":"secondary",children:r.type.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase())})]}),(0,s.jsx)(i.BT,{children:r.userMessage})]}),(0,s.jsxs)(i.Wu,{className:"space-y-4",children:[p&&(0,s.jsx)("div",{className:"p-3 bg-gray-50 rounded-lg",children:(0,s.jsx)("p",{className:"text-xs text-gray-600 font-mono",children:r.message})}),(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsxs)("div",{className:"flex items-center space-x-2 text-sm text-gray-500",children:[(0,s.jsxs)("span",{children:["Recoverable: ",r.recoverable?"✓":"✗"]}),(0,s.jsxs)("span",{children:["Retryable: ",r.retryable?"✓":"✗"]})]}),(0,s.jsxs)("div",{className:"flex space-x-2",children:[r.retryable&&t&&(0,s.jsxs)(o.$,{onClick:t,variant:"outline",size:"sm",children:[(0,s.jsx)(l.A,{className:"h-4 w-4 mr-2"}),"Retry"]}),x()]})]})]})]})}class p extends n.Component{static getDerivedStateFromError(e){return{hasError:!0,error:e}}componentDidCatch(e,r){let t=(0,f._O)(e);(0,f.$E)(t,{componentStack:r.componentStack,errorBoundary:!0,retryCount:this.state.retryCount}),this.setState({errorInfo:r}),this.props.onError&&this.props.onError(e,r),this.props.autoRetry&&t.retryable&&this.state.retryCount<(this.props.maxRetries||3)&&(this.retryTimer=setTimeout(()=>{this.handleRetry()},2e3*(this.state.retryCount+1)))}componentWillUnmount(){this.retryTimer&&clearTimeout(this.retryTimer)}render(){if(this.state.hasError&&this.state.error){if(this.props.fallback)return this.props.fallback;let e=(0,f._O)(this.state.error);return(0,s.jsx)("div",{className:"min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8",children:(0,s.jsxs)("div",{className:"max-w-md w-full space-y-6",children:[(0,s.jsx)(m,{error:e,onRetry:e.retryable?this.handleRetry:void 0,showDetails:this.props.showErrorDetails,variant:"card"}),(0,s.jsx)(i.Zp,{className:"p-6",children:(0,s.jsxs)("div",{className:"text-center space-y-4",children:[(0,s.jsx)("h3",{className:"text-lg font-medium text-gray-900",children:"Recovery Options"}),(0,s.jsxs)("div",{className:"grid grid-cols-1 gap-3",children:[e.retryable&&(0,s.jsxs)(o.$,{onClick:this.handleRetry,variant:"default",className:"w-full",disabled:this.state.retryCount>=(this.props.maxRetries||3),children:["Try Again"," ",this.state.retryCount>0&&"(".concat(this.state.retryCount,"/").concat(this.props.maxRetries||3,")")]}),(0,s.jsx)(o.$,{onClick:this.handleReload,variant:"outline",className:"w-full",children:"Reload Page"}),(0,s.jsx)(o.$,{onClick:this.handleGoToLogin,variant:"outline",className:"w-full",children:"Go to Login"})]}),this.props.showErrorDetails&&this.state.errorInfo&&(0,s.jsxs)("details",{className:"mt-4 text-xs text-gray-500",children:[(0,s.jsx)("summary",{className:"cursor-pointer font-medium",children:"Technical Details"}),(0,s.jsx)("div",{className:"mt-2 p-3 bg-gray-100 rounded text-left",children:(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("strong",{children:"Error:"}),(0,s.jsx)("pre",{className:"whitespace-pre-wrap",children:this.state.error.message})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("strong",{children:"Stack:"}),(0,s.jsx)("pre",{className:"whitespace-pre-wrap text-xs",children:this.state.error.stack})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("strong",{children:"Component Stack:"}),(0,s.jsx)("pre",{className:"whitespace-pre-wrap text-xs",children:this.state.errorInfo.componentStack})]})]})})]})]})})]})})}return this.props.children}constructor(e){super(e),this.handleRetry=()=>{this.retryTimer&&clearTimeout(this.retryTimer),this.setState(e=>({hasError:!1,error:void 0,errorInfo:void 0,retryCount:e.retryCount+1}))},this.handleGoToLogin=()=>{window.location.href="/auth/login"},this.handleReload=()=>{window.location.reload()},this.state={hasError:!1,retryCount:0}}}function y(){let e=(e,r)=>{let t=(0,f._O)(e);switch((0,f.$E)(t,{...r,hookUsage:!0}),t.type){case"session_expired":case"session_invalid":case"token_refresh_failed":window.location.href="/auth/login";break;case"profile_not_found":case"profile_incomplete":window.location.href="/auth/complete-profile";break;case"insufficient_permissions":case"access_denied":window.location.href="/dashboard";break;default:console.error("Authentication error:",t)}},r=async(r,t)=>{try{return await r()}catch(r){throw e(r,t),r}};return{handleAuthError:e,handleAsyncAuthError:r}}},42300:(e,r,t)=>{t.d(r,{mW:()=>a,sm:()=>c});var s=t(95155),n=t(12115),o=t(20063),i=t(76202);let l=(0,n.createContext)(void 0);function a(){let e=(0,n.useContext)(l);if(void 0===e)throw Error("useAuthError must be used within an AuthErrorProvider");return e}function c(e){var r;let{children:t,maxErrorHistory:a=10,autoRedirect:c=!0}=e,[u,d]=(0,n.useState)(null),[h,g]=(0,n.useState)([]),[f,m]=(0,n.useState)(null),p=(0,o.useRouter)(),y=(0,o.usePathname)(),w=(0,n.useCallback)((e,r)=>{let t=(0,i._O)(e);if((0,i.$E)(t,{...r,pathname:y}),d(t),g(e=>[t,...e].slice(0,a)),c&&(0,i.Mw)(t)){let e=(0,i.M3)(t,y);setTimeout(()=>{p.push(e)},2e3)}},[y,p,a,c]),v=(0,n.useCallback)(()=>{d(null)},[]),x=(0,n.useCallback)(()=>{d(null),g([]),m(null)},[]),_=(0,n.useCallback)(()=>{if(f)try{f(),v()}catch(e){w(e instanceof Error?e:Error(String(e)),{context:"retry_last_action"})}},[f,v,w]);(0,n.useEffect)(()=>{let e=e=>{var r,t,s,n;let o=e.reason;o&&((null==(r=o.message)?void 0:r.includes("auth"))||(null==(t=o.message)?void 0:t.includes("session"))||(null==(s=o.message)?void 0:s.includes("token"))||(null==(n=o.message)?void 0:n.includes("unauthorized")))&&w(o,{context:"unhandled_promise_rejection"})},r=e=>{var r,t,s,n;let o=e.error;o&&((null==(r=o.message)?void 0:r.includes("auth"))||(null==(t=o.message)?void 0:t.includes("session"))||(null==(s=o.message)?void 0:s.includes("token"))||(null==(n=o.message)?void 0:n.includes("unauthorized")))&&w(o,{context:"global_error_handler"})};return window.addEventListener("unhandledrejection",e),window.addEventListener("error",r),()=>{window.removeEventListener("unhandledrejection",e),window.removeEventListener("error",r)}},[w]),(0,n.useEffect)(()=>{if(u&&u.type!==i.L4.SESSION_EXPIRED){let e=setTimeout(()=>{v()},5e3);return()=>clearTimeout(e)}},[u,v]);let E={currentError:u,errorHistory:h,showError:w,clearError:v,clearAllErrors:x,retryLastAction:_,hasError:!!u,isRecoverable:null!=(r=null==u?void 0:u.recoverable)&&r};return(0,s.jsx)(l.Provider,{value:E,children:t})}},47061:(e,r,t)=>{t.d(r,{Providers:()=>y,A:()=>p});var s=t(95155),n=t(12115),o=t(20063),i=t(9572),l=t(30218),a=t(6253),c=t(42300),u=t(76202);class d{startTimer(e){var r=this;let t=performance.now();return{end:function(){let s=!(arguments.length>0)||void 0===arguments[0]||arguments[0],n=arguments.length>1?arguments[1]:void 0,o=performance.now()-t;return r.recordMetric({operation:e,duration:o,timestamp:Date.now(),success:s,error:n}),o}}}recordMetric(e){this.metrics.push(e),this.metrics.length>this.maxMetrics&&(this.metrics=this.metrics.slice(-this.maxMetrics))}getOperationStats(e){let r=this.metrics.filter(r=>r.operation===e);if(0===r.length)return null;let t=r.map(e=>e.duration),s=r.filter(e=>e.success).length,n=r.length-s;return{operation:e,totalCalls:r.length,successCount:s,errorCount:n,successRate:s/r.length*100,averageDuration:t.reduce((e,r)=>e+r,0)/t.length,minDuration:Math.min(...t),maxDuration:Math.max(...t),lastCall:r[r.length-1]}}getOverallStats(){var e,r;if(0===this.metrics.length)return null;let t=[...new Set(this.metrics.map(e=>e.operation))].map(e=>this.getOperationStats(e)).filter(e=>null!==e),s=this.metrics.length,n=this.metrics.filter(e=>e.success).length;return{totalCalls:s,successCount:n,errorCount:s-n,successRate:n/s*100,operations:t,timeRange:{start:null==(e=this.metrics[0])?void 0:e.timestamp,end:null==(r=this.metrics[this.metrics.length-1])?void 0:r.timestamp}}}getSlowOperations(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e3;return this.metrics.filter(r=>r.duration>e).sort((e,r)=>r.duration-e.duration).slice(0,10)}getRecentErrors(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:10;return this.metrics.filter(e=>!e.success).sort((e,r)=>r.timestamp-e.timestamp).slice(0,e)}clear(){this.metrics=[]}exportMetrics(){return{metrics:[...this.metrics],summary:this.getOverallStats(),slowOperations:this.getSlowOperations(),recentErrors:this.getRecentErrors()}}constructor(){this.metrics=[],this.maxMetrics=100}}let h=new d;i.supabase||console.error("Supabase client is undefined! Check import paths.");let g=h||{startTimer:e=>({end:function(){let r=!(arguments.length>0)||void 0===arguments[0]||arguments[0];return console.log("[Fallback] ".concat(e,": ").concat(r?"success":"error")),0}})},f={set:function(e,r){let t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:3e5;{let s={value:r,expiry:Date.now()+t};try{localStorage.setItem("auth_cache_".concat(e),JSON.stringify(s))}catch(e){console.warn("Failed to cache auth data:",e)}}},get:e=>{try{let r=localStorage.getItem("auth_cache_".concat(e));if(!r)return null;let t=JSON.parse(r);if(Date.now()>t.expiry)return localStorage.removeItem("auth_cache_".concat(e)),null;return t.value}catch(e){return console.warn("Failed to retrieve cached auth data:",e),null}},clear:e=>{e?localStorage.removeItem("auth_cache_".concat(e)):Object.keys(localStorage).forEach(e=>{e.startsWith("auth_cache_")&&localStorage.removeItem(e)})}},m=(0,n.createContext)(void 0);function p(){let e=(0,n.useContext)(m);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e}function y(e){let{children:r}=e,[t,d]=(0,n.useState)(null),[h,p]=(0,n.useState)(null),[y,w]=(0,n.useState)(null);(0,n.useEffect)(()=>{O.current=y},[y]);let[v,x]=(0,n.useState)(!0),[_,E]=(0,n.useState)(!1),[b,S]=(0,n.useState)(!0),N=(0,o.useRouter)(),k=(0,n.useRef)(0),R=(0,n.useRef)(null),O=(0,n.useRef)(null),A=(0,n.useRef)(new Map),I=(0,n.useRef)(new Map),T=(0,n.useRef)(new Map),j=(0,n.useRef)(!1);(0,n.useEffect)(()=>{try{E(!0);let e=l.t.addConnectionListener(e=>{S(e.isOnline),console.log("[AuthProvider] Network status changed:",e)}),r=T.current,t=A.current,s=I.current;return()=>{try{r.clear(),t.clear(),s.forEach(e=>clearTimeout(e)),s.clear(),j.current=!1,e()}catch(e){console.warn("Error during cleanup:",e)}}}catch(e){console.error("Error in mount effect:",e),E(!0)}},[]);let C=(0,n.useCallback)(async e=>{let r=g.startTimer("fetchUserProfile");k.current+=1;try{var t;if(!e||"string"!=typeof e)return console.warn("Invalid user ID provided to fetchUserProfile:",e),r.end(),null;let s=A.current.get(e);if(s)return console.log("Reusing existing profile operation for user:",e),r.end(),await s;let n=T.current.get(e);if("fetching"===n||"creating"===n)return console.log("Profile operation already in progress for user:",e,"state:",n),r.end(),null;if(R.current===e&&(null==(t=O.current)?void 0:t.id)===e)return console.log("Skipping redundant profile fetch for user:",e),r.end(),O.current;let o=f.get("profile_".concat(e));if(o)return console.log("Using cached profile for user:",e),r.end(),R.current=e,T.current.set(e,"idle"),o;T.current.set(e,"fetching");let l=(async()=>{try{console.log("Fetching profile for user ID: ".concat(e," (fetch #").concat(k.current,")"));let{data:r,error:t}=await i.supabase.from("profiles").select("*").eq("id",e).maybeSingle();if(t)return console.error("Error fetching profile:",{message:t.message,details:t.details,hint:t.hint,code:t.code,userId:e}),T.current.set(e,"error"),null;if(!r)return console.log("Profile not found for user:",e),T.current.set(e,"idle"),null;return console.log("Profile fetched successfully:",r),f.set("profile_".concat(e),r),R.current=e,T.current.set(e,"idle"),r}catch(r){return console.error("Exception fetching profile:",{error:r instanceof Error?r.message:String(r),userId:e,stack:r instanceof Error?r.stack:void 0}),T.current.set(e,"error"),null}})();A.current.set(e,l);let a=await l;return A.current.delete(e),r.end(),a}catch(t){return console.error("Exception in fetchUserProfile:",t),T.current.set(e,"error"),A.current.delete(e),r.end(),null}},[]),P=(0,n.useCallback)(async e=>{let r=g.startTimer("createUserProfile");try{let t=A.current.get(e.id);if(t)return console.log("Reusing existing profile creation operation for user:",e.id),r.end(),await t;let s=T.current.get(e.id);if("creating"===s||"fetching"===s)return console.log("Profile operation already in progress for user:",e.id,"state:",s),r.end(),null;T.current.set(e.id,"creating");let n=(async()=>{try{console.log("Checking if profile exists for user:",e.id);let{data:r,error:t}=await i.supabase.from("profiles").select("*").eq("id",e.id).maybeSingle();if(r)return console.log("Profile already exists for user:",e.id),f.set("profile_".concat(e.id),r),R.current=e.id,T.current.set(e.id,"idle"),r;if(t)return console.error("Error checking profile existence:",t),T.current.set(e.id,"error"),null;let s=e.user_metadata||{},n=s.role||"student",o={id:e.id,email:e.email,first_name:s.first_name||s.firstName||"",last_name:s.last_name||s.lastName||"",phone:s.phone||null,role:n,is_verified:!0,created_at:new Date().toISOString(),updated_at:new Date().toISOString()};console.log("Creating profile with data:",o),console.log("Creating new profile for user:",e.id,"with role:",n),console.log("Profile data:",o);let{data:l,error:a}=await i.supabase.from("profiles").insert([o]).select().single();if(a){if("23505"===a.code){console.log("Profile creation failed due to duplicate key, fetching existing profile for user:",e.id);let{data:r,error:t}=await i.supabase.from("profiles").select("*").eq("id",e.id).single();if(t)return console.error("Error fetching existing profile after duplicate key error:",t),T.current.set(e.id,"error"),null;if(r)return console.log("Successfully retrieved existing profile after duplicate key error:",r.id),f.set("profile_".concat(e.id),r),R.current=e.id,T.current.set(e.id,"idle"),r}return console.error("Error creating profile:",a),console.error("Error details:",{message:a.message,details:a.details,hint:a.hint,code:a.code}),T.current.set(e.id,"error"),null}return console.log("Profile created successfully:",l),f.set("profile_".concat(e.id),l),R.current=e.id,T.current.set(e.id,"idle"),l}catch(r){return console.error("Error in createUserProfile operation:",r),console.error("Error type:",typeof r),console.error("Error stack:",r instanceof Error?r.stack:"No stack trace"),T.current.set(e.id,"error"),null}})();A.current.set(e.id,n);let o=await n;return A.current.delete(e.id),r.end(),o}catch(t){return console.error("Error in createUserProfile:",t),T.current.set(e.id,"error"),A.current.delete(e.id),r.end(),null}},[]),U=(0,n.useCallback)(async e=>new Promise(r=>{let t=I.current.get(e.id);t&&clearTimeout(t);let s=setTimeout(async()=>{try{let t=await P(e);r(t)}catch(e){console.error("Error in debounced profile creation:",e),r(null)}finally{I.current.delete(e.id)}},300);I.current.set(e.id,s)}),[P]);(0,n.useEffect)(()=>{if(!_)return;let e=setTimeout(()=>{console.warn("[AuthProvider] Fallback timeout reached, clearing loading state"),x(!1)},15e3);(async()=>{try{var r,t,s,n;console.log("[AuthProvider] Getting initial session...");let e=i.supabase.auth.getSession(),o=new Promise((e,r)=>setTimeout(()=>r(Error("Session check timeout")),1e4)),a=null,c=null,u=null;try{let{data:{session:r},error:t}=await Promise.race([e,o]);c=null!=(n=null==(a=r)?void 0:a.user)?n:null,u=t}catch(e){if(console.warn("[AuthProvider] Supabase session failed, trying offline state:",e),await l.t.handleAuthError(e)){let e=await l.t.getOfflineAuthState();e&&(a=e.session,c=e.user,console.log("[AuthProvider] Using offline auth state"))}else console.warn("[AuthProvider] Session check failed, continuing without session"),a=null,c=null,u=e}if(console.log("[AuthProvider] Initial session result:",{hasSession:!!a,userId:null==a||null==(r=a.user)?void 0:r.id,userEmail:null==a||null==(t=a.user)?void 0:t.email,error:null==u?void 0:u.message,isOnline:b}),u&&!a&&(console.error("Error getting session:",u),u.message.includes("Network")||u.message.includes("fetch")))throw u;if(p(a),d(c),null==a||null==(s=a.user)?void 0:s.id){console.log("Session user found, fetching profile for:",a.user.id);try{let{data:{user:e},error:r}=await (0,i.safeGetUser)();if(r||!e){console.warn("Safe getUser failed, using session user:",r&&"object"==typeof r&&null!==r&&"message"in r?r.message:"Unknown error");let e=await C(a.user.id);w(e)}else{let r=await C(e.id);r||(console.log("Profile not found on initial load, creating new profile for user:",e.id),r=await U(e)),w(r)}}catch(r){if(console.warn("Safe getUser threw error, using session user instead:",r),r instanceof Error&&(r.message.includes("Network")||r.message.includes("fetch")))throw r;let e=await C(a.user.id);w(e)}}else console.log("No session user found, setting profile to null"),w(null)}catch(r){console.error("Auth session check failed:",r);let e=(0,u._O)(r);if((0,u.$E)(e,{context:"initial_session_check"}),r instanceof Error&&(r.message.includes("Network")||r.message.includes("fetch")))throw r;d(null),p(null),w(null)}finally{clearTimeout(e),x(!1)}})();try{let{data:{subscription:e}}=i.supabase.auth.onAuthStateChange(async(e,r)=>{if(j.current)return void console.log("Auth state change handler already running, skipping");j.current=!0;try{var t,s,n,o;if(console.log("[AuthProvider] Auth state changed:",{event:e,hasSession:!!r,userId:null==r||null==(t=r.user)?void 0:t.id,userEmail:null==r||null==(s=r.user)?void 0:s.email,isOnline:b}),"INITIAL_SESSION"===e){console.log("Skipping INITIAL_SESSION event to prevent auth loop"),x(!1);return}if(!b&&"TOKEN_REFRESHED"===e){console.log("Token refresh attempted while offline, skipping"),x(!1);return}if(p(e=>(null==e?void 0:e.access_token)===(null==r?void 0:r.access_token)?(console.log("Session unchanged, skipping profile fetch"),e):r),d(e=>{var t,s;return(null==e?void 0:e.id)===(null==r||null==(t=r.user)?void 0:t.id)?(console.log("User unchanged, skipping profile fetch"),e):null!=(s=null==r?void 0:r.user)?s:null}),(null==r||null==(n=r.user)?void 0:n.id)&&("SIGNED_IN"===e||"TOKEN_REFRESHED"===e)){if(console.log("New session detected, fetching profile for:",r.user.id),(null==(o=O.current)?void 0:o.id)===r.user.id){console.log("Profile already loaded for user:",r.user.id),x(!1);return}try{let{data:{user:e},error:t}=await (0,i.safeGetUser)();if(t||!e){console.warn("Safe getUser failed in auth change, using session user:",t&&"object"==typeof t&&null!==t&&"message"in t?t.message:"Unknown error");let e=await C(r.user.id);w(e)}else{let r=await C(e.id);r||(console.log("Profile not found, creating new profile for user:",e.id),r=await U(e)),w(r)}}catch(e){console.warn("Safe getUser threw error in auth change, using session user instead:",e);try{let e=await C(r.user.id);w(e)}catch(e){console.error("Failed to fetch profile for session user:",e),w(null)}}}else r||(console.log("No session found, clearing profile"),w(null));x(!1)}finally{j.current=!1}});return()=>e.unsubscribe()}catch(e){console.error("Failed to set up auth listener:",e),x(!1)}},[_,U,C,b]);let L=(0,n.useCallback)(async(e,r)=>{let t=g.startTimer("signIn");x(!0);try{f.clear();let{data:s,error:n}=await i.supabase.auth.signInWithPassword({email:e,password:r});if(n){console.error("Sign in error:",n);let e=(0,u._O)(n);if((0,u.$E)(e,{context:"sign_in"}),n.message.includes("Invalid login credentials")||n.message.includes("Email not confirmed")||n.message.includes("User not found"))return t.end(),{data:null,error:n};throw n}if(s.user&&s.session)return console.log("User signed in successfully:",s.user.email),t.end(!0),{data:s,error:null};throw Error("Authentication failed")}catch(e){if(console.error("Sign in error:",e),e instanceof Error&&(e.message.includes("Network")||e.message.includes("fetch")))throw e;return t.end(),{data:null,error:e}}finally{x(!1)}},[]),M=(0,n.useCallback)(async(e,r,t)=>{let s;try{s=g.startTimer("signUpStudent")}catch(e){console.warn("Performance timer error:",e),s={end:()=>{}}}x(!0),console.log("signUpStudent called with:",{email:e,userData:t});try{var n,o;console.log("Calling supabase.auth.signUp...");let{data:l,error:a}=await i.supabase.auth.signUp({email:e,password:r,options:{data:{...t,role:"student"}}});if(console.log("Supabase signUp response:",{user_id:null==l||null==(n=l.user)?void 0:n.id,user_email:null==l||null==(o=l.user)?void 0:o.email,session_exists:!!(null==l?void 0:l.session),error:null==a?void 0:a.message}),a)throw console.error("Supabase signup error:",a),a;console.log("Student signup successful. User needs to verify email before profile creation.");try{s.end()}catch(e){console.warn("Timer end error:",e)}return{data:l,error:null}}catch(e){console.error("Student sign up error:",e);try{s.end()}catch(e){console.warn("Timer end error:",e)}return{data:null,error:e}}finally{x(!1)}},[]),D=(0,n.useCallback)(async(e,r,t)=>{let s=g.startTimer("signUpCollege");x(!0);try{let{data:n,error:o}=await i.supabase.auth.signUp({email:e,password:r,options:{data:{...t,role:"college"}}});if(o)throw o;return console.log("College signup successful. User needs to verify email before profile creation."),s.end(!0),{data:n,error:null}}catch(e){return console.error("College sign up error:",e),s.end(),{data:null,error:e}}finally{x(!1)}},[]),F=(0,n.useCallback)(async(e,r,t)=>{let s=g.startTimer("signUpAdmin");x(!0);try{let{data:n,error:o}=await i.supabase.auth.signUp({email:e,password:r,options:{data:{...t,role:"admin"}}});if(o)throw o;return console.log("Admin signup successful. User needs to verify email before profile creation."),s.end(!0),{data:n,error:null}}catch(e){return console.error("Admin sign up error:",e),s.end(),{data:null,error:e}}finally{x(!1)}},[]),q=(0,n.useCallback)(async()=>{let e=g.startTimer("signOut");x(!0);try{let{error:r}=await i.supabase.auth.signOut();if(r)throw r;return f.clear(),k.current=0,R.current=null,T.current.clear(),A.current.clear(),I.current.forEach(e=>clearTimeout(e)),I.current.clear(),d(null),p(null),w(null),e.end(!0),{error:null}}catch(r){return console.error("Sign out error:",r),e.end(),{error:r}}finally{x(!1)}},[]),W=(0,n.useCallback)(async e=>{let r=g.startTimer("signInWithOAuth(".concat(e,")"));x(!0);try{let t;f.clear();try{t="".concat(window.location.origin,"/auth/callback")}catch(e){console.warn("Failed to get window.location.origin:",e),t="".concat("http://localhost:3000","/auth/callback")}console.log("OAuth redirect URL:",t);let{data:s,error:n}=await i.supabase.auth.signInWithOAuth({provider:e,options:{redirectTo:t}});if(n)throw n;return r.end(!0),{data:s,error:null}}catch(e){return console.error("OAuth sign in error:",e),r.end(),{data:null,error:e}}finally{x(!1)}},[]),$=(0,n.useCallback)(async e=>{let r=g.startTimer("resetPassword");try{let t="".concat(window.location.origin,"/auth/reset-password"),{error:s}=await i.supabase.auth.resetPasswordForEmail(e,{redirectTo:t});if(s)throw s;return r.end(!0),{error:null}}catch(e){return console.error("Password reset error:",e),r.end(),{error:e}}},[]),K=(0,n.useCallback)(e=>(null==y?void 0:y.role)===e,[null==y?void 0:y.role]),G=(0,n.useCallback)(()=>(null==y?void 0:y.role)==="admin",[null==y?void 0:y.role]),z=(0,n.useCallback)(()=>(null==y?void 0:y.role)==="student",[null==y?void 0:y.role]),B=(0,n.useCallback)(()=>(null==y?void 0:y.role)==="college",[null==y?void 0:y.role]),H=(0,n.useCallback)(()=>{if(console.log("requireAuth: Called",{loading:v,hasUser:!!t,hasSession:!!h,hasProfile:!!y,userEmail:null==t?void 0:t.email,profileRole:null==y?void 0:y.role}),v)return void console.log("requireAuth: Still loading, skipping redirect");setTimeout(()=>{if(v)return void console.log("requireAuth: Still loading after delay, skipping redirect");if(!t||!h){console.log("requireAuth: User not authenticated, redirecting to login"),N.push("/auth/login");return}if(!y){console.log("requireAuth: User authenticated but no profile, redirecting to complete profile"),console.log("requireAuth: User details:",{userId:t.id,userEmail:t.email}),N.push("/auth/complete-profile");return}console.log("requireAuth: All checks passed, user is authenticated")},200)},[v,t,h,y,N]),V=(0,n.useCallback)(e=>{if(v)return void console.log("requireRole: Still loading, skipping redirect");setTimeout(()=>{if(!v){if(!t||!h){console.log("requireRole: User not authenticated, redirecting to login"),N.push("/auth/login");return}if(!y){console.log("requireRole: User authenticated but no profile, redirecting to complete profile"),N.push("/auth/complete-profile");return}if(y.role!==e){switch(console.log("requireRole: User role '".concat(y.role,"' does not match required role '").concat(e,"', redirecting to dashboard")),y.role){case"admin":N.push("/admin");break;case"college":N.push("/colleges/dashboard");break;default:N.push("/dashboard")}return}}},100)},[v,t,h,y,N]),X=(0,n.useMemo)(()=>({user:t,session:h,profile:y,loading:v,isOnline:b,signIn:L,signUpStudent:M,signUpCollege:D,signUpAdmin:F,signOut:q,signInWithOAuth:W,resetPassword:$,hasRole:K,isAdmin:G,isStudent:z,isCollege:B,requireAuth:H,requireRole:V}),[t,h,y,v,b,L,M,D,F,q,W,$,K,G,z,B,H,V]);if(!_)return(0,s.jsx)(c.sm,{children:(0,s.jsx)(a.AuthErrorBoundary,{children:(0,s.jsx)(m.Provider,{value:{user:null,session:null,profile:null,loading:!0,isOnline:!0,signIn:async()=>({data:null,error:null}),signUpStudent:async()=>({data:null,error:null}),signUpCollege:async()=>({data:null,error:null}),signUpAdmin:async()=>({data:null,error:null}),signOut:async()=>({error:null}),signInWithOAuth:async()=>({data:null,error:null}),resetPassword:async()=>({error:null}),hasRole:()=>!1,isAdmin:()=>!1,isStudent:()=>!1,isCollege:()=>!1,requireAuth:()=>{},requireRole:()=>{}},children:r})})});if(!X)throw console.error("AuthContext value is undefined!"),Error("AuthContext value is undefined");return(0,s.jsx)(c.sm,{children:(0,s.jsx)(a.AuthErrorBoundary,{children:(0,s.jsx)(m.Provider,{value:X,children:r})})})}},76202:(e,r,t)=>{t.d(r,{$E:()=>l,L4:()=>s,M3:()=>i,Mw:()=>o,_O:()=>n});var s=function(e){return e.INVALID_CREDENTIALS="invalid_credentials",e.EMAIL_NOT_CONFIRMED="email_not_confirmed",e.USER_NOT_FOUND="user_not_found",e.WEAK_PASSWORD="weak_password",e.EMAIL_ALREADY_EXISTS="email_already_exists",e.SESSION_EXPIRED="session_expired",e.SESSION_INVALID="session_invalid",e.TOKEN_REFRESH_FAILED="token_refresh_failed",e.PROFILE_NOT_FOUND="profile_not_found",e.PROFILE_CREATION_FAILED="profile_creation_failed",e.PROFILE_UPDATE_FAILED="profile_update_failed",e.PROFILE_INCOMPLETE="profile_incomplete",e.INSUFFICIENT_PERMISSIONS="insufficient_permissions",e.ROLE_MISMATCH="role_mismatch",e.ACCESS_DENIED="access_denied",e.NETWORK_ERROR="network_error",e.TIMEOUT_ERROR="timeout_error",e.SERVER_ERROR="server_error",e.UNKNOWN_ERROR="unknown_error",e.VALIDATION_ERROR="validation_error",e}({});function n(e){var r;if(!e)return{type:"unknown_error",message:"Unknown error occurred",userMessage:"An unexpected error occurred. Please try again.",recoverable:!0,retryable:!0,action:"retry"};let t=(null==(r=e.message)?void 0:r.toLowerCase())||e.toString().toLowerCase(),s=e.code||e.status;if(t.includes("invalid login credentials")||t.includes("invalid email or password"))return{type:"invalid_credentials",message:e.message||e.toString(),userMessage:"Invalid email or password. Please check your credentials and try again.",recoverable:!0,retryable:!0,action:"retry"};if(t.includes("email not confirmed")||t.includes("confirm your email"))return{type:"email_not_confirmed",message:e.message||e.toString(),userMessage:"Please check your email and click the confirmation link before signing in.",recoverable:!0,retryable:!1,action:"login"};if(t.includes("user not found")||"user_not_found"===s)return{type:"user_not_found",message:e.message||e.toString(),userMessage:"No account found with this email address.",recoverable:!0,retryable:!1,action:"signup"};if(t.includes("password")&&(t.includes("weak")||t.includes("strength")))return{type:"weak_password",message:e.message||e.toString(),userMessage:"Password is too weak. Please use at least 8 characters with uppercase, lowercase, and numbers.",recoverable:!0,retryable:!0,action:"retry"};if(t.includes("email")&&t.includes("already")&&t.includes("registered"))return{type:"email_already_exists",message:e.message||e.toString(),userMessage:"An account with this email already exists. Try signing in instead.",recoverable:!0,retryable:!1,action:"login"};if(t.includes("session")&&(t.includes("expired")||t.includes("invalid")))return{type:"session_expired",message:e.message||e.toString(),userMessage:"Your session has expired. Please sign in again.",recoverable:!0,retryable:!1,redirectTo:"/auth/login",action:"login"};if(t.includes("token")&&t.includes("refresh"))return{type:"token_refresh_failed",message:e.message||e.toString(),userMessage:"Session refresh failed. Please sign in again.",recoverable:!0,retryable:!1,redirectTo:"/auth/login",action:"login"};if(t.includes("profile")){if(t.includes("not found"))return{type:"profile_not_found",message:e.message||e.toString(),userMessage:"Profile not found. Please complete your profile setup.",recoverable:!0,retryable:!1,redirectTo:"/auth/complete-profile",action:"complete_profile"};if(t.includes("incomplete"))return{type:"profile_incomplete",message:e.message||e.toString(),userMessage:"Please complete your profile to continue.",recoverable:!0,retryable:!1,redirectTo:"/auth/complete-profile",action:"complete_profile"}}return t.includes("permission")||t.includes("unauthorized")||t.includes("access denied")?{type:"insufficient_permissions",message:e.message||e.toString(),userMessage:"You don't have permission to access this resource.",recoverable:!1,retryable:!1,redirectTo:"/dashboard",action:"login"}:t.includes("network")||t.includes("fetch")||t.includes("connection")?{type:"network_error",message:e.message||e.toString(),userMessage:"Network error. Please check your internet connection and try again.",recoverable:!0,retryable:!0,action:"retry"}:t.includes("timeout")||"TIMEOUT"===s?{type:"timeout_error",message:e.message||e.toString(),userMessage:"Request timed out. Please try again.",recoverable:!0,retryable:!0,action:"retry"}:s&&"number"==typeof s&&s>=500||t.includes("server error")||t.includes("internal error")?{type:"server_error",message:e.message||e.toString(),userMessage:"Server error. Please try again in a few moments.",recoverable:!0,retryable:!0,action:"retry"}:{type:"unknown_error",message:e.message||"Unknown error",userMessage:"An unexpected error occurred. Please try again or contact support if the problem persists.",recoverable:!0,retryable:!0,action:"retry"}}function o(e){return!!(e.redirectTo&&!e.retryable)}function i(e,r){if(e.redirectTo)return e.redirectTo;switch(e.type){case"session_expired":case"session_invalid":case"token_refresh_failed":case"invalid_credentials":case"email_already_exists":return"/auth/login";case"profile_not_found":case"profile_incomplete":return"/auth/complete-profile";case"user_not_found":return"/auth/signup";case"insufficient_permissions":case"access_denied":return"/dashboard";default:return r||"/"}}function l(e,r){new Date().toISOString(),e.type,e.message,e.userMessage,e.recoverable,e.retryable}}}]);